<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>사용자 결제 및 구독 관리</title>
</head>
<body>
    <h1>결제 및 구독 관리</h1>
    <button onclick="fetchPayments()">결제 내역 조회</button>
    <button onclick="fetchSubscription()">구독 정보 조회</button>
    
    <h2>결제 내역</h2>
    <ul id="paymentList"></ul>

    <h2>구독 정보</h2>
    <div id="subscriptionInfo"></div>

    <h2>결제 취소/환불 요청</h2>
    <label for="cancelPaymentId">취소할 결제 ID:</label>
    <input type="number" id="cancelPaymentId">
    <label for="cancelReason">취소 사유:</label>
    <input type="text" id="cancelReason">
    <button onclick="cancelPayment()">결제 취소/환불 요청</button>
    <p id="cancelStatus"></p>

    <script>
        const accessToken = localStorage.getItem("accessToken") || null;

        async function fetchPayments(year = null, month = null, page = 1, limit = 10) {
            try {
                const url = new URL("http://localhost:8000/v1/users/me/payments");
                url.searchParams.append("page", page);
                url.searchParams.append("limit", limit);
                if (year) url.searchParams.append("year", year);
                if (month) url.searchParams.append("month", month);

                const response = await fetch(url, {
                    headers: {
                        "Authorization": "Bearer " + accessToken
                    }
                });

                if (!response.ok) {
                    alert(`오류 발생: ${response.status}`);
                    return;
                }

                const data = await response.json();

                // JSON 형태로 데이터 전체 출력
                document.getElementById("paymentList").innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                
            } catch (error) {
                alert("결제 내역 조회 중 오류 발생");
                console.error(error);
            }
        }

        async function fetchSubscription() {
            try {
                const response = await fetch("http://localhost:8000/v1/users/me/subscriptions", {
                    headers: {
                        "Authorization": "Bearer " + accessToken
                    }
                });

                if (!response.ok) {
                    if (response.status === 404) {
                        alert("구독 정보가 없습니다.");
                    } else {
                        alert(`오류 발생: ${response.status}`);
                    }
                    return;
                }

                const data = await response.json();
                document.getElementById("subscriptionInfo").innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            } catch (error) {
                alert("구독 정보 조회 중 오류 발생");
                console.error(error);
            }
        }

        async function cancelPayment() {
            const paymentId = document.getElementById("cancelPaymentId").value;
            const reason = document.getElementById("cancelReason").value;
            if (!paymentId || !reason) {
                alert("결제 ID와 사유를 입력해주세요.");
                return;
            }

            try {
                const response = await fetch(`http://localhost:8000/v1/users/me/payments/${paymentId}/cancel`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + accessToken
                    },
                    body: JSON.stringify({ reason })
                });
                
                if (response.ok) {
                    document.getElementById("cancelStatus").textContent = "환불 요청이 성공적으로 접수되었습니다.";
                } else {
                    const errorData = await response.json();
                    document.getElementById("cancelStatus").textContent = "환불 요청 실패: " + errorData.detail;
                }
            } catch (error) {
                alert("환불 요청 중 오류 발생");
                console.error(error);
            }
        }
    </script>
</body>
</html>
